use crate::{
    Mmio,
    backend::dwc::{consts::genmask, udphy::config::UdphyGrfReg},
};

#[derive(Clone, Copy)]
pub struct Regmap(usize);

impl Regmap {
    pub fn new(base: Mmio) -> Self {
        Self(base.as_ptr() as usize)
    }

    pub fn base(&self) -> usize {
        self.0
    }

    pub fn grfreg_write(&self, reg: &UdphyGrfReg, en: bool) {
        let mut tmp = if en { reg.enable } else { reg.disable };
        let mask = genmask(reg.bitend, reg.bitstart) as u32;
        let val = (tmp << reg.bitstart) | (mask << 16);
        self.reg_write(reg.offset, val);
    }

    pub fn reg_read(&self, offset: u32) -> u32 {
        let addr = (self.0 + offset as usize) as *const u32;
        unsafe { addr.read_volatile() }
    }

    pub fn reg_write(&self, offset: u32, val: u32) {
        let addr = (self.0 + offset as usize) as *mut u32;
        // debug!(
        //     "Regmap write: addr=0x{:p}, val=0x{:08x}, offset=0x{:x}",
        //     addr, val, offset
        // );
        unsafe {
            addr.write_volatile(val);
        }
    }

    pub fn multi_reg_write(&self, regs: &[RegSequence]) {
        for reg in regs {
            self.reg_write(reg.reg, reg.def);
        }
    }

    pub fn update_bits(&self, offset: u32, mask: u32, val: u32) {
        let current = self.reg_read(offset);
        let new = (current & !mask) | val;
        self.reg_write(offset, new);
    }
}

/// 寄存器配置项
#[derive(Debug, Clone, Copy)]
pub struct RegSequence {
    reg: u32,
    def: u32,
}

macro_rules! def_sequence {
    ($n:ident; $({$reg:expr, $val:expr}),* $(,)?) => {
        pub const $n: &[RegSequence] = &[
            $(
                RegSequence {
                    reg: $reg,
                    def: $val,
                },
            )*
        ];
    };
}

def_sequence! {
    RK3588_UDPHY_24M_REFCLK_CFG;
    {0x0090, 0x68}, {0x0094, 0x68},
    {0x0128, 0x24}, {0x012c, 0x44},
    {0x0130, 0x3f}, {0x0134, 0x44},
    {0x015c, 0xa9}, {0x0160, 0x71},
    {0x0164, 0x71}, {0x0168, 0xa9},
    {0x0174, 0xa9}, {0x0178, 0x71},
    {0x017c, 0x71}, {0x0180, 0xa9},
    {0x018c, 0x41}, {0x0190, 0x00},
    {0x0194, 0x05}, {0x01ac, 0x2a},
    {0x01b0, 0x17}, {0x01b4, 0x17},
    {0x01b8, 0x2a}, {0x01c8, 0x04},
    {0x01cc, 0x08}, {0x01d0, 0x08},
    {0x01d4, 0x04}, {0x01d8, 0x20},
    {0x01dc, 0x01}, {0x01e0, 0x09},
    {0x01e4, 0x03}, {0x01f0, 0x29},
    {0x01f4, 0x02}, {0x01f8, 0x02},
    {0x01fc, 0x29}, {0x0208, 0x2a},
    {0x020c, 0x17}, {0x0210, 0x17},
    {0x0214, 0x2a}, {0x0224, 0x20},
    {0x03f0, 0x0a}, {0x03f4, 0x07},
    {0x03f8, 0x07}, {0x03fc, 0x0c},
    {0x0404, 0x12}, {0x0408, 0x1a},
    {0x040c, 0x1a}, {0x0410, 0x3f},
    {0x0ce0, 0x68}, {0x0ce8, 0xd0},
    {0x0cf0, 0x87}, {0x0cf8, 0x70},
    {0x0d00, 0x70}, {0x0d08, 0xa9},
    {0x1ce0, 0x68}, {0x1ce8, 0xd0},
    {0x1cf0, 0x87}, {0x1cf8, 0x70},
    {0x1d00, 0x70}, {0x1d08, 0xa9},
    {0x0a3c, 0xd0}, {0x0a44, 0xd0},
    {0x0a48, 0x01}, {0x0a4c, 0x0d},
    {0x0a54, 0xe0}, {0x0a5c, 0xe0},
    {0x0a64, 0xa8}, {0x1a3c, 0xd0},
    {0x1a44, 0xd0}, {0x1a48, 0x01},
    {0x1a4c, 0x0d}, {0x1a54, 0xe0},
    {0x1a5c, 0xe0}, {0x1a64, 0xa8}
}

def_sequence! {
    RK3588_UDPHY_INIT_SEQUENCE;
    {0x0104, 0x44}, {0x0234, 0xE8},
    {0x0248, 0x44}, {0x028C, 0x18},
    {0x081C, 0xE5}, {0x0878, 0x00},
    {0x0994, 0x1C}, {0x0AF0, 0x00},
    {0x181C, 0xE5}, {0x1878, 0x00},
    {0x1994, 0x1C}, {0x1AF0, 0x00},
    {0x0428, 0x60}, {0x0D58, 0x33},
    {0x1D58, 0x33}, {0x0990, 0x74},
    {0x0D64, 0x17}, {0x08C8, 0x13},
    {0x1990, 0x74}, {0x1D64, 0x17},
    {0x18C8, 0x13}, {0x0D90, 0x40},
    {0x0DA8, 0x40}, {0x0DC0, 0x40},
    {0x0DD8, 0x40}, {0x1D90, 0x40},
    {0x1DA8, 0x40}, {0x1DC0, 0x40},
    {0x1DD8, 0x40}, {0x03C0, 0x30},
    {0x03C4, 0x06}, {0x0E10, 0x00},
    {0x1E10, 0x00}, {0x043C, 0x0F},
    {0x0D2C, 0xFF}, {0x1D2C, 0xFF},
    {0x0D34, 0x0F}, {0x1D34, 0x0F},
    {0x08FC, 0x2A}, {0x0914, 0x28},
    {0x0A30, 0x03}, {0x0E38, 0x05},
    {0x0ECC, 0x27}, {0x0ED0, 0x22},
    {0x0ED4, 0x26}, {0x18FC, 0x2A},
    {0x1914, 0x28}, {0x1A30, 0x03},
    {0x1E38, 0x05}, {0x1ECC, 0x27},
    {0x1ED0, 0x22}, {0x1ED4, 0x26},
    {0x0048, 0x0F}, {0x0060, 0x3C},
    {0x0064, 0xF7}, {0x006C, 0x20},
    {0x0070, 0x7D}, {0x0074, 0x68},
    {0x0AF4, 0x1A}, {0x1AF4, 0x1A},
    {0x0440, 0x3F}, {0x10D4, 0x08},
    {0x20D4, 0x08}, {0x00D4, 0x30},
    {0x0024, 0x6e},
}
